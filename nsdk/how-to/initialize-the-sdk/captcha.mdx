import TabItem from "@theme/TabItem";
import {LanguageTabs} from "@site/src/components/LanguageTabs";

# Capctha options for authentication process

In this section, we will see how to use the different captcha options available in the Cardinal SDK.

## What's are the options available in Cardinal SDK?

### Friendly Captcha (v1)

You can use Friendly Captcha as a captcha option in the Cardinal SDK. Friendly Captcha is a privacy-focused captcha
service that is GDPR compliant. You can check it out [here](https://developer.friendlycaptcha.com/docs/v1/)

<LanguageTabs>

<TabItem value = "kotlin">

```kotlin
import com.icure.cardinal.sdk.CardinalSdk
import com.icure.cardinal.sdk.auth.AuthenticationProcessTelecomType
import com.icure.cardinal.sdk.auth.CaptchaOptions
import com.icure.cardinal.sdk.storage.impl.FileStorageFacade

val process = CardinalSdk.initializeWithProcess(
    applicationId = null,
    baseUrl = "https://api.icure.cloud",
    messageGatewayUrl = "https://msg-gw.icure.cloud",
    externalServicesSpecId = "SPEC_ID",
    userTelecom = "johndoe@example.com",
    userTelecomType = AuthenticationProcessTelecomType.Email,
    baseStorage = FileStorageFacade("FILE_PATH"),
    processId = "PROCESS_ID",
    captcha = CaptchaOptions.FriendlyCaptcha(friendlyCaptchaResponse),
)
```

</TabItem>

<TabItem value = "typescript">

```typescript
import {
  AuthenticationProcessTelecomType,
  CaptchaOptions,
  CardinalSdk,
  StorageFacade
} from "@icure/cardinal-sdk";

const authenticationStep = await CardinalSdk.initializeWithProcess(
	"APP_ID",
	"https://api.icure.cloud",
	"https://msg-gw.icure.cloud",
	process.env.EXTERNAL_SERVICES_SPEC_ID!!,
	process.env.EMAIL_AUTHENTICATION_PROCESS_ID!!,
	AuthenticationProcessTelecomType.Email,
	email,
	new CaptchaOptions.FriendlyCaptcha({solution: friendlyCaptchaResponse}),
	StorageFacade.usingBrowserLocalStorage(),
)
```

</TabItem>

</LanguageTabs>


### Google reCAPTCHA (v3)

You can use Google reCAPTCHA as a captcha option in the Cardinal SDK. Google reCAPTCHA is a captcha service that is
widely used across the internet. You can check it out [here](https://developers.google.com/recaptcha/docs/v3)

<LanguageTabs>

<TabItem value = "kotlin">

```kotlin
import com.icure.cardinal.sdk.CardinalSdk
import com.icure.cardinal.sdk.auth.AuthenticationProcessTelecomType
import com.icure.cardinal.sdk.auth.CaptchaOptions
import com.icure.cardinal.sdk.storage.impl.FileStorageFacade

val process = CardinalSdk.initializeWithProcess(
    applicationId = null,
    baseUrl = "https://api.icure.cloud",
    messageGatewayUrl = "https://msg-gw.icure.cloud",
    externalServicesSpecId = "SPEC_ID",
    userTelecom = "johndoe@example.com",
    userTelecomType = AuthenticationProcessTelecomType.Email,
    baseStorage = FileStorageFacade("FILE_PATH"),
    processId = "PROCESS_ID",
    captcha = CaptchaOptions.Recaptcha(reCaptchaResponse),
)
```

</TabItem>

<TabItem value = "typescript">

```typescript
import {
  AuthenticationProcessTelecomType,
  CaptchaOptions,
  CardinalSdk,
  StorageFacade
} from "@icure/cardinal-sdk";

const authenticationStep = await CardinalSdk.initializeWithProcess(
	"APP_ID",
	"https://api.icure.cloud",
	"https://msg-gw.icure.cloud",
	process.env.EXTERNAL_SERVICES_SPEC_ID!!,
	process.env.EMAIL_AUTHENTICATION_PROCESS_ID!!,
	AuthenticationProcessTelecomType.Email,
	email,
	new CaptchaOptions.Recaptcha({solution: reCaptchaResponse}),
	StorageFacade.usingBrowserLocalStorage(),
)
```

</TabItem>

</LanguageTabs>

### Kerberus

Kerberus is an open-source Kotlin Multiplatform proof of work captcha library. It is designed around this paper
[mCaptcha: Replacing Captchas with Rate limiters to Improve Security and Accessibility](https://dl.acm.org/doi/full/10.1145/3660628)

Kerberus is designed on top of Kryptom, a Kotlin Multiplatform cryptography library. Check it out [here](https://github.com/icure/kryptom)

Part of the implementation is based on the [mCaptcha implementation](https://github.com/mCaptcha/pow_wasm/blob/cb6bbd0e05078e1dadf546de5848d30f5d11a00c/src/lib.rs)

## How to use Kerberus ?

In this section, we will see how to use Kerberus with the Cardinal SDK.

### How to use Kerberus with the Cardinal SDK?

By default, you can use Kerberus directly by initializing the Cardinal SDK.

<LanguageTabs>

<TabItem value = "kotlin">

```kotlin
import com.icure.cardinal.sdk.CardinalSdk
import com.icure.cardinal.sdk.auth.AuthenticationProcessTelecomType
import com.icure.cardinal.sdk.auth.CaptchaOptions
import com.icure.cardinal.sdk.storage.impl.FileStorageFacade

val process = CardinalSdk.initializeWithProcess(
	applicationId = "APP_ID",
	baseUrl = "https://api.icure.cloud",
	messageGatewayUrl = "https://msg-gw.icure.cloud",
	externalServicesSpecId = "SPEC_ID",
	userTelecom = "johndoe@example.be",
	userTelecomType = AuthenticationProcessTelecomType.Email,
	baseStorage = FileStorageFacade("FILE_PATH"),
	processId = "PROCESS_ID",
	captcha = CaptchaOptions.Kerberus.Delegated { progress -> println("Progress: ${progress * 100}%") },
)
```

</TabItem>

<TabItem value = "typescript">

```typescript
import {
  AuthenticationProcessTelecomType,
  CaptchaOptions,
  CardinalSdk,
  StorageFacade
} from "@icure/cardinal-sdk";

const authenticationStep = await CardinalSdk.initializeWithProcess(
	"APP_ID",
	"https://api.icure.cloud",
	"https://msg-gw.icure.cloud",
	process.env.EXTERNAL_SERVICES_SPEC_ID!!,
	process.env.EMAIL_AUTHENTICATION_PROCESS_ID!!,
	AuthenticationProcessTelecomType.Email,
	email,
	new CaptchaOptions.Kerberus.Delegated({onProgress: (x) => console.log('Progress', x)}),
	StorageFacade.usingBrowserLocalStorage(),
)
```

</TabItem>

</LanguageTabs>

And there you go! During the initialization of the Cardinal SDK, Kerberus will be used for authentication processes.

:::note

In this case, the challenge and resolution will be automatically handled by the Cardinal SDK. The resolution time will
depend on the complexity of the challenge. If you wish to manually manage the challenge and resolution, please refer to
the section [How to use a pre-computed Kerberus Solution in Cardinal SDK?](#how-to-use-a-pre-computed-kerberus-solution-in-cardinal-sdk)

:::

### How to use a pre-computed Kerberus Solution in Cardinal SDK?

To speed up the authentication process for your users, you can pre-compute the Kerberus challenge solution before
initializing the Cardinal SDK.

<LanguageTabs>

<TabItem value = "kotlin">

To do so, you need to:

1. Retrieve the Kerberus challenge by making a `GET` request to the URL `https://msg-gw.icure.cloud/{SPECID}/challenge`.
2. Calculate the challenge solution using the method `resolveChallenge(config: Challenge, serializedInput: String, cryptoService: CryptoService?, onProgress: (Double) => Unit): Solution`.
3. Initialize the Cardinal SDK with the pre-computed solution.

```kotlin
import com.icure.cardinal.sdk.CardinalSdk
import com.icure.cardinal.sdk.auth.AuthenticationProcessTelecomType
import com.icure.cardinal.sdk.auth.CaptchaOptions
import com.icure.cardinal.sdk.storage.impl.FileStorageFacade

lateinit var challenge: Challenge // This is a placeholder for the challenge that you will fetch

val solution = resolveChallenge(challenge, "SPEC_ID") { progress ->
    println("Progress: ${progress * 100}%")
}

val process = CardinalSdk.initializeWithProcess(
	applicationId = "APP_ID",
	baseUrl = "https://api.icure.cloud",
	messageGatewayUrl = "https://msg-gw.icure.cloud",
	externalServicesSpecId = "SPEC_ID",
	userTelecom = "johndoe@example.be",
	userTelecomType = AuthenticationProcessTelecomType.Email,
	baseStorage = FileStorageFacade("FILE_PATH"),
	processId = "PROCESS_ID",
	captcha = CaptchaOptions.Kerberus.Computed(solution) // pre-computed solution
)
```

</TabItem>

<TabItem value = "typescript">

To do so, you need to:

1.	Retrieve the Kerberus challenge by making a `GET` request to the URL `https://msg-gw.icure.cloud/{SPECID}/challenge`.
2.	Calculate the challenge solution using the method `resolveChallenge(config: Challenge, serializedInput: string, cryptoService?: XCryptoService, onProgress: (progress: number) => void): Solution`.
3.	Initialize the Cardinal SDK with the pre-computed solution.

```typescript
import {
  AuthenticationProcessTelecomType,
  CaptchaOptions,
  CardinalSdk,
  StorageFacade
} from "@icure/cardinal-sdk";

const challenge: Challenge = undefined as any // This is a placeholder for the challenge that you will fetch

const solution = await resolveChallenge(challenge, "SPEC_ID")

const authenticationStep = await CardinalSdk.initializeWithProcess(
	"APP_ID",
	"https://api.icure.cloud",
	"https://msg-gw.icure.cloud",
	process.env.EXTERNAL_SERVICES_SPEC_ID!!,
	process.env.EMAIL_AUTHENTICATION_PROCESS_ID!!,
	AuthenticationProcessTelecomType.Email,
	email,
    new CaptchaOptions.Kerberus.Computed({solution}), // pre-computed solution
	StorageFacade.usingBrowserLocalStorage(),
)
```

</TabItem>

</LanguageTabs>

### How to use Kerberus as a standalone library in Expo?


:::note

:construction: Work in progress :construction:

:::

