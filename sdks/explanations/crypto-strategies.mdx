---
slug: crypto-strategies
tags:
 - crypto
 - keys
---
# Crypto Strategies

iCure uses end-to-end encryption to ensure the protection of your users data even in case of breach.
If a malicious third party gets access to iCure's databases or to the account of one of your users all the data they
retrieve will be useless unless they also get access to the private keys of your users.

The iCure SDK handles automatically encryption of your data for the most part, however, there are some aspects of
encryption that can be handled optimally only with input from your application.
This is where the Crypto Strategies come into play: by providing your own implementation of the `CryptoStrategies`
interface you can customise the behaviour of iCure to improve the security and accessibility of your data.

The main issues you can address through the crypto strategies are *key recovery* and *server trust*.

## Key Recovery

End-to-end encryption is great to protect the data of your users from unauthorised access, but it also means that if
your users lose their private keys they will lose access to their data as well!

The iCure SDK provides some data and key recovery mechanisms, but it would always be better if you also provide a
custom recovery method that fits your application.
For example, you could allow your users to save their private key in a file, encrypted by a custom password.

In order to use custom key recovery in your application you will have to implement the methods `notifyKeyPairGeneration`
and `recoverAndVerifyKeys` of the crypto strategies interface.
When the SDK determines that a new key pair should be generated it will call the `notifyKeyPairGeneration` method of
the crypto strategies, allowing you to prompt the user to save the key for future recovery.
When instead the SDK realises that a key pair for the logged data owner is not available on the device it will call the
`recoverAndVerifyKeys`, which allows you to prompt the user to load the key he saved in the past.

## Server trust

In order to allow your users to share the encrypted data with other users the iCure SDK needs to know the public keys of
the users.
The SDK will automatically retrieve the public keys of the users from the iCure server, but how can you be sure that the
public keys you are retrieving are the real public keys of the user?
If the iCure server got compromised the attacker could trick your users to share data with him instead of the intended
recipient.

You can be assured that we are doing our best to protect our servers, but if you want to be extra safe you can reduce
the trust you put in the iCure server by verifying the public keys of the users yourself, by implementing the
`verifyDelegatePublicKeys` of the crypto strategies interface.

When a user is about to share data with a new delegate user (*for the first time only*) the SDK will retrieve the public
key of the delegate user from the iCure server and call the `verifyDelegatePublicKeys` method of the crypto strategies.
You can then prompt the user to verify that the public key is correct using some external verification method and return
the result to the SDK.

Again you can choose the verification method that best fits your application. For example, you could ask the user to
check the public key on the website of the doctor/clinic, or you could ask the user to scan a QR code generated by the
delegate user app.

:::note

Although not directly related to the crypto strategies, this concept of trust also applies to the give-access-back
mechanisms explained in the [how-to on a user losing his key](../how-to/how-to-authenticate-a-user/how-to-manage-lost-key#give-access-back-to-another-data-owner):
whenever you share data with a user you should verify that the public key you are using is the correct one.

:::

### Verification of own recovered keys

As previously mentioned iCure has some built-in mechanisms to recover the keys of your users.
Similarly to public keys, however, if iCure gets compromised the attacker may trick your user into "recovering" a key
pair which is actually controlled by the attacker, resulting in the attacker having access to all data encrypted with
such pair.

To prevent this from happening the iCure SDK will not use keys recovered through iCure means for encryption of new data
unless the user verifies the keys, through the `recoverAndVerifyKeys` method (custom key recovery and key verification
are done by the same method).

Key verification is not as important as recovery, and iCure's default key recovery methods are not going to be as
effective as a custom recovery method, however it is much simpler to implement and use verification over recovery.
If a key was recovered by the iCure sdk your user can simply verify it by confirming that the public key of the
recovered key matches the public key of a key he has created in the past.
Since the public key is not sensitive information it can be stored in the clear on the device, meaning that the user is
more likely to recover the public key than to recover the private key.

## Simple crypto strategies

The iCure SDK provides a default implementation of the crypto strategies interface, the `SimpleCryptoStrategies`.

You can use the `SimpleCryptoStrategies` to kickstart the development of your application, but you should always replace
them with a real custom implementation before releasing your application.

The `SimpleCryptoStrategies` do not provide any key recovery mechanism by themselves and fully trust the iCure server
(no key verification is done). You can also pass in input some key pairs which you think may not be available on the
device, so they will be considered as recovered, but this is not necessary.

## Further reading

For more details on how to implement the crypto strategies interface please refer to the [API documentation](../references/modules).
